# zmodload zsh/zprof # uncomment to profile startup time

# General zsh options
setopt appendhistory autocd extendedglob notify
unsetopt beep

# History file
HISTFILE="$HOME/.zsh_history"
HISTSIZE=50000
SAVEHIST=10000

# Enable Powerlevel10k instant prompt
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Update PATH
command -v dircolors >/dev/null 2>&1 && eval "$(dircolors)"
command -v /opt/homebrew/bin/brew >/dev/null 2>&1 && eval "$(/opt/homebrew/bin/brew shellenv | grep -v '^export PATH')"
export PATH="$PATH:$HOME/scripts"
export PATH="$PATH:$HOME/.local/bin"
export PATH="$PATH:$HOME/.local/share/nvim/mason/bin"
export PATH="$PATH:/opt/homebrew/bin:/opt/homebrew/sbin" # do not replace common system packages by linuxbrew versions
export PATH="$PATH:$ANDROID_HOME/cmdline-tools/latest/bin"
export PATH="$PATH:/opt/mssql-tools18/bin"
export PATH="$PATH:$HOME/.rd/bin"
export PATH="$PATH:${KREW_ROOT:-$HOME/.krew}/bin"

# Set theme
source ~/.zsh/themes/powerlevel10k/powerlevel10k.zsh-theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Disable delay on pasting text
DISABLE_MAGIC_FUNCTIONS="true"

# Completion: zsh-autosuggestions
source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# # Completion: Load additional completion functions
fpath+=~/.zfunc
fpath+=~/.zsh/plugins/zsh-completions/src
fpath+=/opt/homebrew/share/zsh/site-functions
fpath+=~/.asdf/completions
[ -d ~/.zfunc ] || mkdir ~/.zfunc

# Completion: Load compinit + bashcompinit
# only check cache once a day to prevent startup delay: https://gist.github.com/ctechols/ca1035271ad134841284
autoload -Uz compinit bashcompinit
for dump in ~/.zcompdump(N.mh+24); do
    compinit
    bashcompinit
done
compinit -C
bashcompinit -C

# Load plugins
source ~/.zsh/plugins/fzf-tab/fzf-tab.plugin.zsh 2> /dev/null
source ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh 2> /dev/null
source ~/.zsh/plugins/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh 2> /dev/null

# Case insensitive completions
zstyle ":completion:*" matcher-list "m:{a-z}={A-Za-z}"

# Autojump
command -v zoxide >/dev/null 2>&1 && eval "$(zoxide init zsh)"

# Completions
command -v pipx >/dev/null 2>&1 && eval "$(register-python-argcomplete pipx)"
if command -v poetry >/dev/null 2>&1 && [[ ! -f ~/.zfunc/_poetry || ~/.zfunc/_poetry -ot $(command -v poetry) ]]; then
    poetry completions zsh > ~/.zfunc/_poetry
fi
if command -v conveyor >/dev/null 2>&1 && [[ ! -f ~/.zfunc/_conveyor || ~/.zfunc/_conveyor -ot $(command -v conveyor) ]]; then
    conveyor completion zsh > ~/.zfunc/_conveyor
fi

# Tool version manager: mise
command -v mise >/dev/null 2>&1 && eval "$(mise activate zsh)"

# Nix
if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh";
fi

# Completion: Enable hidden files in cd completion, but without ./ and ../
_comp_options+=(globdots)
zstyle -e ':completion:*' special-dirs '[[ $PREFIX = (../)#(|.|..) ]]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}

# Set up fzf
source <(fzf --zsh)
export FZF_DEFAULT_OPTS='--color=pointer:2,prompt:4,info:242,gutter:-1 --pointer "→ " --prompt "→ "'

# Set up fzf-tab
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1la --icons --group-directories-first --no-user --no-time --no-filesize --no-permissions --color=always $realpath'
zstyle ':fzf-tab:*' fzf-bindings 'tab:accept'
zstyle ':fzf-tab:*' fzf-flags --color=pointer:2,prompt:4,info:242,gutter:-1 --pointer "→ " --prompt "→ "
# zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'

# Atuin
command -v atuin >/dev/null 2>&1 && eval "$(atuin init zsh)"

# Aliases
source $HOME/.bash_aliases

# Keybinds
source ~/.zsh_binds

# CA certificates
CERT_PATH=/etc/ssl/certs/cacert.pem
export SSL_CERT_FILE=${CERT_PATH}
export REQUESTS_CA_BUNDLE=${CERT_PATH}

# Load p10k config
# [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
# [[ -f ~/.config/shell/p10k.mise.zsh ]] && source ~/.config/shell/p10k.mise.zsh
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# eval "$(starship init zsh)"

# zprof # uncomment to profile startup time