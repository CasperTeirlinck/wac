# shellcheck disable=SC2148

setopt appendhistory autocd extendedglob notify
unsetopt beep

# Enable Powerlevel10k instant prompt
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Android tools
export ANDROID_HOME="$HOME/Android/Sdk"

# Update PATH
eval "$(dircolors)"
command -v /home/linuxbrew/.linuxbrew/bin/brew >/dev/null 2>&1 && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv | grep -v '^export PATH')"
export PATH="$PATH:$HOME/scripts"
export PATH="$PATH:$HOME/.local/bin"
export PATH="$PATH:/snap/bin"
export PATH="$PATH:$HOME/.local/share/nvim/mason/bin"
export PATH="$PATH:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" # do not replace common system packages by linuxbrew versions
export PATH="$PATH:$ANDROID_HOME/cmdline-tools/latest/bin"
export PATH="$PATH:$ANDROID_HOME/platform-tools"
export PATH="$PATH:/opt/mssql-tools18/bin"
export PATH="$PATH:$HOME/flutter/flutter/bin"
# manually add vscode path needed because auto append windows paths is disabled in wsl to improve performance
export PATH="$PATH:/mnt/c/Users/casper/AppData/Local/Programs/Microsoft VS Code/bin"

# Set theme
source ~/.zsh/themes/powerlevel10k/powerlevel10k.zsh-theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Disable delay on pasting text
DISABLE_MAGIC_FUNCTIONS="true"

# Completion: zsh-autosuggestions
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# Completion: Load additional completion functions
fpath+=~/.zfunc
fpath+=~/.zsh/plugins/zsh-completions/src
fpath+=/home/linuxbrew/.linuxbrew/share/zsh/site-functions
fpath+=~/.asdf/completions
[ -d ~/.zfunc ] || mkdir ~/.zfunc

# Completion: Load compinit + bashcompinit
autoload -Uz compinit bashcompinit
compinit
bashcompinit

# Load plugins
source ~/.zsh/plugins/fzf-tab/fzf-tab.plugin.zsh 2> /dev/null
source ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh 2> /dev/null
source ~/.zsh/plugins/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh 2> /dev/null

# Case insensitive completions
zstyle ":completion:*" matcher-list "m:{a-z}={A-Za-z}"

# Autojump
command -v zoxide >/dev/null 2>&1 && eval "$(zoxide init zsh)"

# Completions
command -v pipx >/dev/null 2>&1 && eval "$(register-python-argcomplete pipx)"
command -v poetry >/dev/null 2>&1 && poetry completions zsh > ~/.zfunc/_poetry
command -v conveyor >/dev/null 2>&1 && conveyor completion zsh > ~/.zfunc/_conveyor

[ -f ~/.nix-profile/etc/profile.d/nix.sh ] && source ~/.nix-profile/etc/profile.d/nix.sh

# Completion: Enable hidden files in cd completion, but without ./ and ../
_comp_options+=(globdots)
zstyle -e ':completion:*' special-dirs '[[ $PREFIX = (../)#(|.|..) ]]'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# Completion: Set fzf styles
if [ -n "${commands[fzf-share]}" ]; then
  source "$(fzf-share)/key-bindings.zsh"
  source "$(fzf-share)/completion.zsh"
fi

export FZF_DEFAULT_OPTS='
  --color=pointer:2,prompt:4,info:242,gutter:-1 --pointer "→ " --prompt "→ "
'
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1la --icons --group-directories-first --no-user --no-time --no-filesize --no-permissions --color=always $realpath'
zstyle ':fzf-tab:*' fzf-bindings 'tab:accept'

command -v atuin >/dev/null 2>&1 && eval "$(atuin init zsh)"

[[ ! -f ~/.bash_aliases ]] || source ~/.bash_aliases
[[ ! -f ~/.zsh_binds ]] || source ~/.zsh_binds
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

[[ ! -z "$SSH_AUTH_SOCK" ]] || eval "$(ssh-agent -s)" > /dev/null
[[ ! -f ~/.ssh/id_ed25519 ]] || ssh-add ~/.ssh/id_ed25519 > /dev/null 2>&1
[[ ! -f ~/.ssh/id_imec_gh ]] || ssh-add ~/.ssh/id_imec_gh > /dev/null 2>&1
[[ ! -f ~/.ssh/id_imec_do ]] || ssh-add ~/.ssh/id_imec_do > /dev/null 2>&1
[[ ! -f ~/.ssh/id_plotlytrial ]] || ssh-add ~/.ssh/id_plotlytrial > /dev/null 2>&1

[[ ! -f ~/yandex-cloud/path.bash.inc ]] || source ~/yandex-cloud/path.bash.inc
[[ ! -f ~/yandex-cloud/completion.zsh.inc ]] || source ~/yandex-cloud/completion.zsh.inc